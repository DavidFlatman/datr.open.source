#!/usr/bin/perl

#-------------------------------------------------------------------------------
#                                                                               
#   Name:       make.qt.config                                                  
#                                                                               
#   Classification: UNCLASSIFIED, OPEN SOURCE                                   
#                                                                               
#   Purpose:    Make the configuration file for creating Qt Makefiles.          
#               This procedure should be run after you create a new main        
#               program.
#                                                       
#   -dpath          Search the path for SOURCES and HEADER; pass to compiler.   
#   -Dmacro=42      Pass qualifier to compiler.                                 
#   -fflag          Add the given flag to the CXXFLAGS                          
#   -Ipath          Search the path for HEADERS; pass to compiler.              
#   -lname          Pass qualifier to linker.                                   
#   -Lpath          Pass qualifier to linker.                                   
#   -mpath/file     Path to main source file.                                   
#   -qpath          qrc resource file                                           
#   -TDpath         Path to target dependency 
#   --threads=      Number of threads available to use. 
#
#                                                                                
#   @version    2016-04-04  DHF     File creation.  
#   @version    2020-10-19  DHF     Combined make.qt.config and makepro. Added
#                                   --threads=.                            
#
#   @TODO: Try using print <<EOF instead of quotes inside functions.                                                                               
#-------------------------------------------------------------------------------

use POSIX qw{strftime};
use threads;
use threads::shared;
use Thread::Queue;

my @cxx_flags;
my @directories;
my @inc_pathes;
my @library;
my @macros;
my @targetdeps;
my @main_files;
my @src_files;
my @hdr_files;
my @img_files;
my @qrc_files;
my @qmake_command;

my %config;
my %qt;
my %main_files_path;

my $version = "V 1.0.0 ";   # $version is same length as the value held.        
my @date = localtime;
my $date_time = sprintf("%04d-%02d-%02d", $date[5]+1900, $date[4]+1, $date[3]);
my $qmake = "qmake-qt4";

my $thread_count = `nproc`;
my $main_directory;

my $qrc_file = "../common/qt.qrc";

for my $a (@ARGV)
{
    if ($a =~ /^-c(.*)/) {
        $config{$1} = 1;

    } elsif ($a =~ /^-d(.*)/) {
        push(@directories, $1);

    } elsif ($a =~ /^-D(.*)/) {
        push(@macros, $1);

    } elsif ($a =~ /^-f(.*)/) {
        push(@cxx_flags, $1);
        
    } elsif ($a =~ /^-I(.*)/) {
        push(@inc_pathes, $1);

    } elsif ($a =~ /^-l(.*)/) {
        push(@library, $1);

    } elsif ($a =~ /^-L/) {
        push(@library, $a);

    } elsif ($a =~ /^--qmake=(.*)/) {
        $qmake = $1;

    } elsif ($a =~ /^-qt(.*)/) {
        $qt{$1} = 1;
        
    } elsif ($a =~ /^-q(.*)/) {
        $qrc_file = $1;

    } elsif ($a =~ /^-TD(.*)/) {
        push(@targetdeps, $1);

    } elsif ($a =~ /^--threads=(.*)/) {
        $thread_count = $1;

    }
}

$config{"qt"} = 1;
$config{"thread"} = 1;
$config{"stl"} = 1;
$config{"largefile"} = 1;
$config{"warn_off"} = 1;

if($^O ne 'darwin') {
    $config{"x11"} = 1;
}

if ($#directories == 0) {
    push(@directories, "../common");
}

open (BUILD, ">build") or die "Unable to open build\n$!\n";
print BUILD <<EOF;
#!/bin/bash

#-------------------------------------------------------------------------------
#   Name:           build                                                       
#                                                                               
#   Purpose:        Call each of the Makefiles generated by the latest          
#                   execution of ./makeconfig and ./configure.sh.               
#                                                                               
#   Note:           This file is automatically generated by the make.qt.config  
#                   tool.  You should [probably] not modify this file by hand.  
#                                                                               
#   Version:                                                                    
#       $date_time    MQC       Generated by make.qt.config $version            
#                                                                               
#-------------------------------------------------------------------------------

EOF

&print_build("clear && clear ");

open(QRC, ">${qrc_file}") or die "unable to open ${qrc_file}\n$!\n";
print QRC "<!DOCTYPE RCC><RCC version=\"1.0\">\n";
print QRC "  <qresource>\n";

foreach my $dir (@directories)
{
    &process_dir($dir);
}

print QRC "  </qresource>\n";
print QRC "</RCC>\n";
close QRC;

print BUILD "\n";

close BUILD;

&print_pro_file();

foreach $command(@qmake_command) {
    system($command);

}

sub process_dir
{
    my ($dir) = @_;

    opendir (DIR, $dir) or die "Unable to open directory ${dir}\n$!\n";
    my $file;

    while (defined($file = readdir(DIR))) {
        my $path = $dir . "/" . $file;
        $main_directory = $dir . "/";
        if ($file eq "." or $file eq "..") {
            #-------------------------------------------------------------------
            # skip this and parent directory.                                   
            #-------------------------------------------------------------------

        } elsif ($file =~ /(.*)\.c$/i or $file =~ /(.*)\.cpp$/i or $file =~ /(.*)\.cc/i) {
            my $test = system("grep --silent \"int main\" \"${path}\"");
            if ($test == 0) {
                push(@main_files, $1);
                $main_files_path{$1} = $path;
                print "main program: ${file}\n";
                push(@qmake_command, "${qmake} -o Makefile-$1 $1.pro"
                    . "\n\n");
                &print_build("&& \\\n make -j8 -f Makefile-$1");

            } else {
                push(@src_files, $path);
            }

            &search_file($path);

        } elsif ($file =~ /\.h$/i or $file =~ /\.hpp$/i or $file =~ /\.hh/i) {
            push(@hdr_files, $path);

            &search_file($path);

        } elsif ($file =~ /\.qrc$/) {
            push(@qrc_files, $path);

        } elsif (
            $file =~ /\.gif$/
         or $file =~ /.png$/ 
         or $file =~ /.jpg$/ 
         or $file =~ /.ico$/
         or $file =~ /.svg$/
         or $file =~ /.svgz$/
         or $file =~ /.tgz$/
         or $file =~ /.css$/
         or $file =~ /.js$/
         or $file =~ /.htm$/
         or $file =~ /.html$/
        ) {
            push(@img_files, $path);
            #print QRC "    <file>" . $path . "</file>\n";
        }

    }
}

sub print_pro_file
{
    foreach $file (@main_files)
    {
        open(PRO, ">${file}.pro") or die "unable to open ${file}\n$!\n";
        print PRO "
        ########################################################################
        #   qmake project file built on $todaysdate                                     
        #   Generated by makepro (v. 0.1.0) on $todaysdate                              
        #   Command Line:                                                               
        ";
        print PRO "#\n";

        foreach my $a (@ARGV) {
            printf PRO ("        #   %-70s\n", $a);
        }

        print PRO "
        ########################################################################   
        \n";


        foreach my $key (sort(keys(%config))) {
            print PRO "CONFIG          += " . $key . "\n";
        }
        print PRO "\n";

        foreach my $key (sort(keys(%qt))) {
            print PRO "QT              += " . $key . "\n";
        }
        print PRO "\n";

        foreach my $flag (@cxx_flags) {
            print PRO "QMAKE_CXXFLAGS  += " . $flag . "\n";
        }
        print PRO "\n";

        foreach my $path (@inc_pathes) {
            print PRO "INCLUDEPATH     += " . $path . "\n";
        }
        print PRO "\n";

        foreach my $lib (@library) {
            print PRO "LIBS            += " . $lib . "\n";
        }
        print PRO "\n";

        print PRO "DESTDIR         =   bin\n";
        print PRO "OBJECTS_DIR     =   obj\n";
        print PRO "MOC_DIR         =   moc\n";
        print PRO "\n";

        foreach my $target (@targetdeps) {
            print PRO "PRE_TARGETDEPS  += " . $target. "\n";
        }
        print PRO "\n";

        foreach my $header (@hdr_files) {
            print PRO "HEADERS         += " . $header. "\n";
        }
        print PRO "\n";

        print PRO "SOURCES         += " . $main_files_path{$file} . "\n";

        print PRO "\n";

        foreach my $source (@src_files) {
            print PRO "SOURCES         += " . $source . "\n";
        }
        print PRO "\n";

        foreach $qrc (@qrc_files) {
            print PRO "RESOURCES       += " . $qrc . "\n";
        }
        print PRO "\n";

        close PRO;
    }
}

sub print_build
{
    my ($line) = @_;
    printf BUILD ("%-76s", $line);
}


#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
sub search_file
{
    my ($d) = @_;

    &qt_search("core",   "Q_OBJECT",$d);
    &qt_search("gui",    "QWidget", $d);
    &qt_search("network","QNet",    $d);
    &qt_search("sql",    "QSql",    $d);
    &qt_search("svg",    "QSvg",    $d);
    &qt_search("webkit", "QWeb",    $d);
    &qt_search("webkitwidgets", "QWeb",    $d);
    &qt_search("xml",    "QXml",    $d);

}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
sub qt_search
{
    my ($module, $string, $file) = @_;

    if (!defined($qt{$module})) {
        $test = system("grep --silent \"${string}\"  \"${file}\"");
        if ($test == 0) {
            $qt{$module} = 1;
        }
    }
}